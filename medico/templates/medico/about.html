{% extends 'medico/base.html' %}
{% load static %}

{% block title %}À propos{% endblock %}

{% block content %}
<h1>Présentation de l'application <strong>MEDICO</strong></h1>

<hr>
<h2>Localisation des patients</h2>

<div>
    <label for="searchPatient">Rechercher un patient :</label>
    <input type="text" id="searchPatient" placeholder="Nom ou prénom...">
</div>

<div id="map" style="height: 500px; margin-top: 10px;"></div>

<!-- Leaflet CSS + JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
    var map = L.map('map').setView([48.8566, 2.3522], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
    }).addTo(map);

    var markers = [];

    console.log("---- Début de génération des markers ----");

    {% for c in consultations %}
        {% if c.latitude is not None and c.longitude is not None %}
            var lat = parseFloat("{{ c.latitude }}");
            var lon = parseFloat("{{ c.longitude }}");
            if (!isNaN(lat) && !isNaN(lon)) {
                console.log("Consultation trouvée : {{ c.patient_prenom }} {{ c.patient_nom }}");

                var marker = L.marker([lat, lon])
                    .bindPopup("<b>{{ c.patient_prenom }} {{ c.patient_nom }}</b><br>{{ c.patient_adresse }}");

                marker.searchName = "{{ c.patient_prenom }} {{ c.patient_nom }}".toLowerCase();

                marker.addTo(map);
                markers.push(marker);

                console.log("Marker ajouté :", marker.searchName);
            }
        {% endif %}
    {% endfor %}

    console.log("TOTAL MARKERS =", markers.length);

    // Recherche dynamique
    document.getElementById('searchPatient').addEventListener('input', function() {
        var query = this.value.toLowerCase();

        markers.forEach(function(marker) {
            if (marker.searchName.includes(query)) {
                if (!map.hasLayer(marker)) {
                    marker.addTo(map);
                }
            } else {
                if (map.hasLayer(marker)) {
                    map.removeLayer(marker);
                }
            }
        });
    });
</script>

{% endblock %}
